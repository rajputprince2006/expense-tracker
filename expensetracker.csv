import csv
import os
from datetime import datetime

csv_f = "manager.csv"
header = ['Date', 'Category', 'Amount']


def my_csv():
    if not os.path.isfile(csv_f) or os.path.getsize(csv_f) == 0:
        with open(csv_f, "w", newline="", encoding='utf-8') as f:
            writer = csv.writer(f)
            writer.writerow(header)


def read_exp():
    my_csv()
    rows = []

    with open(csv_f, "r", newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f)

        for row in reader:
            if not row or any(k not in row for k in header):
                continue

            try:
                float(row["Amount"])
            except Exception:
                continue

            rows.append(row)

    return rows


def writ_exp(rows):
    with open(csv_f, "w", newline="", encoding='utf-8') as f:
        writer = csv.DictWriter(f, fieldnames=header)
        writer.writeheader()
        writer.writerows(rows)


def add_exp():
    d = input("Enter date (YYYY-MM-DD) [Leave blank for today]: ").strip()
    if not d:
        d = datetime.today().strftime("%Y-%m-%d")

    try:
        datetime.fromisoformat(d)
    except ValueError:
        print("Invalid date format. Use YYYY-MM-DD.")
        return

    c = input("Category (blank = Misc): ").strip() or "Misc"

    amt = input("Enter amount: ").strip()
    try:
        amt_ = float(amt)
    except ValueError:
        print("Invalid amount. Use numbers only.")
        return

    with open(csv_f, "a", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow([d, c, f"{amt_:.2f}"])

    print("Expense added successfully.")


def view_exp():
    rows = read_exp()

    if not rows:
        print("No expenses recorded.")
        return

    print("\nIndex   Date         Category        Amount")
    print("-" * 55)

    total = 0.0
    for i, r in enumerate(rows, start=1):
        amt = float(r.get("Amount", 0))
        total += amt
        print(f"{i:<6}  {r['Date']:<12} {r['Category']:<14} {r['Amount']}")

    print("-" * 55)
    print(f"Total Amount Spent: {total:.2f}")


def del_exp():
    rows = read_exp()

    if not rows:
        print("Nothing to delete.")
        return

    view_exp()

    ind = input("Enter the index to delete (blank = cancel): ").strip()
    if not ind:
        print("Operation cancelled.")
        return

    try:
        idx = int(ind)
        if not (1 <= idx <= len(rows)):
            print("Invalid index number.")
            return
    except ValueError:
        print("Please enter a valid number.")
        return

    del rows[idx - 1]
    writ_exp(rows)

    print("Entry deleted successfully.")


def sum_total():
    rows = read_exp()
    if not rows:
        print("No data available.")
        return

    total = 0.0
    c_sum = {}

    for r in rows:
        amt = float(r['Amount'])
        total += amt
        cat = r['Category']
        c_sum[cat] = c_sum.get(cat, 0.0) + amt

    print(f"\nTotal Amount Spent: {total:.2f}")
    print("\nSpending by Category:")

    for cat, amt in c_sum.items():
        print(f"- {cat}: {amt:.2f}")


try:
    import matplotlib.pyplot as plt
except Exception:
    plt = None


def plot_cat():
    if plt is None:
        print("Matplotlib not installed. Install it with: pip install matplotlib")
        return

    rows = read_exp()
    if not rows:
        print("No data to plot.")
        return

    c_sum = {}
    for r in rows:
        amt = float(r["Amount"])
        cat = r["Category"]
        c_sum[cat] = c_sum.get(cat, 0.0) + amt

    plt.bar(c_sum.keys(), c_sum.values())
    plt.title("Spending by Category")
    plt.xlabel("Category")
    plt.ylabel("Amount")
    plt.tight_layout()
    plt.show()


def plot_date():
    if plt is None:
        print("Matplotlib not installed. Install it with: pip install matplotlib")
        return

    rows = read_exp()
    if not rows:
        print("No data available.")
        return

    mon_sum = {}

    for r in rows:
        try:
            dt = datetime.fromisoformat(r["Date"])
        except ValueError:
            continue

        key = f"{dt.year}-{dt.month:02d}"
        mon_sum[key] = mon_sum.get(key, 0.0) + float(r["Amount"])

    if not mon_sum:
        print("No valid date entries to plot.")
        return

    months = sorted(mon_sum.keys())
    values = [mon_sum[m] for m in months]

    plt.plot(months, values, marker='o')
    plt.title("Monthly Expenses")
    plt.xlabel("Month")
    plt.ylabel("Amount")
    plt.tight_layout()
    plt.show()


def menu():
    my_csv()

    while True:
        print("\n========= Personal Budget & Expense Tracker =========")
        print("1. Add Expense")
        print("2. View Expenses")
        print("3. Delete Expense")
        print("4. Summary")
        print("5. Plot by Category")
        print("6. Plot by Month")
        print("7. Exit")

        ch = input("\nEnter your choice: ").strip()

        if ch == "1":
            add_exp()
        elif ch == "2":
            view_exp()
        elif ch == "3":
            del_exp()
        elif ch == "4":
            sum_total()
        elif ch == "5":
            plot_cat()
        elif ch == "6":
            plot_date()
        elif ch == "7":
            print("Exiting program.")
            break
        else:
            print("Invalid choice. Try again.")


menu()
